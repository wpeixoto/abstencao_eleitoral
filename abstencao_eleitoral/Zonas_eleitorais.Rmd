---
title: "Zonas eleitorais"
author: "William Peixoto"
date: "25 de junho de 2018"
output: 
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# RStudio Version 1.1.442 
DATA_DIR = "/home/william/Downloads/Dados/TSE/mz"
# DATA_DIR = "/home/william/temp/dd/mz"

```

```{r load data, echo=FALSE}
source("aux.R")  # TODO: Como garantir que o source ocorre apenas uma vez? Isso faz diferença?

anoturno = function(ano, turno) {
  ano_s = as.character(ano)
  paste0(ano_s, "_", turno)
}

dados = list()
for (ano in c(1998, 2002, 2006, 2010, 2014)) {
  for (turno in c("1", "2")) {
    
    filename = paste0(DATA_DIR, "/", anoturno(ano, turno), ".csv")
    
    if (!file.exists(filename)) {
      stop(paste("Arquivo", filename, "não existe"))
    }
    
    df = read.csv(filename, encoding = "ISO-8859", sep = ",", stringsAsFactors = F)

    dados[[anoturno(ano, turno)]] = list(ANO=ano, TURNO=turno, DF=df)
  }
}
```


# Zonas eleitorais

As zonas eleitorais são compostas de seções, onde os eleitores efetivamente votam. O TSE divulga as informações agrupadas por zona e por seção. Nesta página, apenas os dados agrupados pelo TSE serão analisados.

![](./imagens/mapa_df_por_zona.png)

A quantidade de zonas aumentou junto com a população de eleitores. Eram 14 em 1998 e são 21 hoje.

## Distribuições de frequências

Foram investgadas as aderências dos dados à distribuição Normal. Nas próximas seções, aparecem os resultados dos testes demonstrando que, embora uma ou outra amostra se aproxime razoavelmente da N~, a maioria diverge fortemente dela. 

Mais detalhes na [página específica](Zonas_distribuicao.Rmd).

# Comparações
Apesar de as distribuições evidentemente não serem Normais, serão usados seus métodos para exercitar os conhecimentos adquiridos no curso.

## Comparações entre turnos

Para eleições no mesmo ano, há razões suficientes para considerar que sejam observações sucessivas em uma mesma população (Lei das Eleições).


```{r Compara turnos, echo=FALSE, results='asis'}
source("NormalCompara.R")

comparacao = data.frame(
  ano = rep(0, 5),
  media = rep(0, 5),
  t = rep(0, 5),
  p_value = rep(0, 5),
  #intervalo = rep(0, 5)
  low = rep(NA, 5),
  upp = rep(NA, 5)
)

cnt=1
for (i in c(1,3,5,7,9)) { # Há 10 data frames com dados de 5 anos
  df1 = dados[[i]]$DF   # Primeiro turno
  df2 = dados[[i+1]]$DF # Segundo turno
  diferenca_turnos = df1$TAXA_ABSTENCAO - df2$TAXA_ABSTENCAO
  T = t.test(diferenca_turnos)
  comparacao[cnt, ] = list(
    dados[[i]]$ANO,
    mean(diferenca_turnos),
    T$statistic,
    T$p.value,
    # paste0("[", as.character(T$conf.int[1]), ", ", as.character(T$conf.int[2]), "]") 
    T$conf.int[1],
    T$conf.int[2]
  )
  cnt = cnt + 1
  
  # z1 <- to_z(df1$TAXA_ABSTENCAO)
  z1 <- df1$TAXA_ABSTENCAO
  # m1 = mean(z1)
  m1 = mean(df1$TAXA_ABSTENCAO)
  # sd1 = sd(z1)
  sd1 = ErrP(df1$TAXA_ABSTENCAO)
  
  # z2 <- to_z(df2$TAXA_ABSTENCAO)
  z2 = df2$TAXA_ABSTENCAO
  m2 = mean(z2)
  sd2 = ErrP(z2) #, sd(z2))

  dnormalComp(m1, sd1, m2, sd2, 
              main_title = paste(dados[[i]]$ANO),
              a1n="1º Turno",
              a2n="2º Turno")
  # screen(2) # , new=FALSE)
  text(-4.3,0.38,paste("Area  =",11),cex=0.8,pos=4)
  # dnormalComp(m1, sd1, m2, sd2, main_title = paste(dados[[i]]$ANO))
  # print("===")
  # print(paste(m1, sd1, m2, sd2, paste(dados[[i]]$ANO)))
  # Version 1.1.442 
  print("\n**rwaaa** teste")
  
}
```

### Resultados

TODO: A comparação abaixo é geral. Falta comparar dois a dois para calcular região crítica

```{r Mostra sumário comparacao turnos, echo=FALSE}
library(knitr)
kable(comparacao, format="pandoc")
```


Sob a hipótese nula $H_0$, as médias das diferenças seriam zero por não haver diferenças significativas. Contudo, em todos os anos de 2002 em diante foi identificada uma diferença com nível confiança de 95%, o que rejeita $H_0$. Para 1998, contudo, não é possível rejeitá-la, o que nos deixa inseguros para afirmar que a diferença seja significativa.

Esses resultados podem ser visualizados no seguinte gráfico:

```{r, echo=FALSE}
library(plotrix)
# plot(comparacao$media)
xx = 1:5
# plotCI(xx, comparacao$media, ui=comparacao$upp, li=comparacao$low)
plotCI(c(1998, 2002, 2006, 2010, 2014), 
       main="Médias das diferenças entre abstenções\ndo primeiro para o segundo turno",
       comparacao$media, 
       ui=comparacao$upp, 
       li=comparacao$low, 
       ylab="Médias das diferenças", 
       xlab="anos", 
       xlim=c(1997, 2015)
       )
abline(0,0)
```

Observe-se que, para 1998, o intervalo de confiança chega muito perto da igualdade estatística entre as taxas de abstenção do primeiro para o segundo turno. Nessa eleição, houve segunto turno apenas para governador.

### Força dos testes

TODO: Calcular região crítica

Hipóteses
- $H_0: \mu = \mu_0$
- $H_a: \mu \neq \mu_0$

Região crítica
- $\alpha = P(x < x_c | )$ TODO: WTH?

```{r}
source("NormalPadrao.R")


# dnormalComp()
```


## Comparações entre anos distintos
Foram consideradas independentes as eleições ocorridas em anos distintos.

### Força dos testes